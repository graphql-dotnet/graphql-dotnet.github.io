<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 5.9.1"/><meta data-react-helmet="true" name="description" content="GraphQL for .NET"/><meta data-react-helmet="true" name="keywords" content="graphql,api,web api,.net,.net core"/><style data-href="/styles.71340509c59b3fced1c9.css" data-identity="gatsby-global-css">.landing{margin:1.8rem auto}html{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;font-family:sans-serif}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{-webkit-text-decoration-skip:objects;background-color:transparent}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{box-sizing:border-box;font:112.5%/1.45em georgia,serif;overflow-y:scroll}*,:after,:before{box-sizing:inherit}body{word-wrap:break-word;-ms-font-feature-settings:"kern","liga","clig","calt";font-feature-settings:"kern","liga","clig","calt";color:rgba(0,0,0,.8);font-family:georgia,serif;font-kerning:normal;font-weight:400}img{margin:0 0 1.45rem;max-width:100%;padding:0}h1{font-size:2.25rem}h1,h2{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h2{font-size:1.62671rem}h3{font-size:1.38316rem}h3,h4{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h4{font-size:1rem}h5{font-size:.85028rem}h5,h6{color:inherit;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-weight:700;line-height:1.1;margin:0 0 1.45rem;padding:0;text-rendering:optimizeLegibility}h6{font-size:.78405rem}hgroup{margin:0 0 1.45rem;padding:0}ol,ul{list-style-image:none;list-style-position:outside;margin:0 0 1.45rem 1.45rem}ol{padding:0}dd,dl,figure,p{margin:0 0 1.45rem;padding:0}pre{word-wrap:normal;background:rgba(0,0,0,.04);border-radius:3px;font-size:.85rem;line-height:1.42;margin:0 0 1.45rem;overflow:auto;padding:1.45rem}table{border-collapse:collapse;font-size:1rem;line-height:1.45rem;width:100%}fieldset,table{margin:0 0 1.45rem;padding:0}blockquote{margin:0 1.45rem 1.45rem;padding:0}form,iframe,noscript{margin:0 0 1.45rem;padding:0}hr{background:rgba(0,0,0,.2);border:none;height:1px;margin:0 0 calc(1.45rem - 1px);padding:0}address{margin:0 0 1.45rem;padding:0}b,dt,strong,th{font-weight:700}li{margin-bottom:.725rem}ol li,ul li{padding-left:0}li>ol,li>ul{margin-bottom:.725rem;margin-left:1.45rem;margin-top:.725rem}blockquote :last-child,li :last-child,p :last-child{margin-bottom:0}li>p{margin-bottom:.725rem}code,kbd,samp{font-size:.85rem;line-height:1.45rem}abbr,abbr[title],acronym{border-bottom:1px dotted rgba(0,0,0,.5);cursor:help}abbr[title]{text-decoration:none}td,th,thead{text-align:left}td,th{font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";border-bottom:1px solid rgba(0,0,0,.12);padding:.725rem .96667rem calc(.725rem - 1px)}td:first-child,th:first-child{padding-left:0}td:last-child,th:last-child{padding-right:0}code,tt{background-color:rgba(0,0,0,.04);border-radius:3px;font-family:SFMono-Regular,Consolas,Roboto Mono,Droid Sans Mono,Liberation Mono,Menlo,Courier,monospace;padding:.2em 0}pre code{background:none;line-height:1.42}code:after,code:before,tt:after,tt:before{content:" ";letter-spacing:-.2em}pre code:after,pre code:before,pre tt:after,pre tt:before{content:""}@media only screen and (max-width:480px){html{font-size:100%}}code[class*=language-],pre[class*=language-]{word-wrap:normal;color:#657b83;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;tab-size:4;text-align:left;white-space:pre;word-break:normal;word-spacing:normal}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:#073642}pre[class*=language-]{border-radius:.3em;margin:.5em 0;overflow:auto;padding:1em}:not(pre)>code[class*=language-],pre[class*=language-]{background-color:#fdf6e3}:not(pre)>code[class*=language-]{border-radius:.3em;padding:.1em}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#93a1a1}.token.punctuation{color:#586e75}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#268bd2}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string,.token.url{color:#2aa198}.token.entity{background:#eee8d5;color:#657b83}.token.atrule,.token.attr-value,.token.keyword{color:#859900}.token.class-name,.token.function{color:#b58900}.token.important,.token.regex,.token.variable{color:#cb4b16}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}html{color:#2c3e50}body,html{-webkit-font-smoothing:antialiased;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;font-size:16px;overflow:auto;text-rendering:optimizeLegibility}body{margin:0}#___gatsby{overflow:auto}#gatsby-focus-wrapper{height:100%}ul{padding:0}li,ul{margin:0}a{color:#3eaf7c;text-decoration:underline}.header{border-bottom:1px solid #eaecef;height:60px}.header ul{padding:20px}.header li{display:inline-block;list-style:none;padding:0 12px}.header li a{color:#2c3e50;text-decoration:none}.footer{height:60px}.footer,.header{flex:none}.page-body{display:flex;flex-direction:column;height:calc(100% - 60px)}.content{height:100%;overflow-x:hidden;overflow-y:hidden;padding:2em;width:100%}.content ul{margin:20px 0}.content ul li{margin:0 0 0 30px}.content blockquote{border-left:7px solid #eaecef;margin:0 0 1.45rem;padding:30px}.content pre{margin-bottom:1.45rem}.content-body,.content-toolbar{margin:0 auto;max-width:740px}.content-toolbar{padding:1rem 0}.nav{border:0;flex-grow:1;min-width:18rem;order:1;overflow-x:hidden;overflow-y:inherit;padding-top:2rem}.nav li{list-style:none}.nav li span{display:block;font-weight:600;padding:.25rem 1rem .25rem 1.5rem}.nav ul{margin-bottom:15px}.nav ul a{border-left:.25rem solid transparent;color:#2c3e50;display:inline-block;line-height:1.4;padding:.25rem 1rem .25rem 1.25rem;text-decoration:none}.nav ul a:hover{color:#3eaf7c}.nav ul a.active{border-left:.25rem solid #3eaf7c;color:#3eaf7c;text-decoration:none}@media (min-width:768px){#___gatsby,body,html{height:100%;overflow-y:hidden}.page-body{flex-direction:row}.content{overflow-y:auto}.ads,.nav{order:-1}.nav{border-right:1px solid #eaecef;overflow-y:auto}}</style><title data-react-helmet="true">GraphQL .NET</title><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><nav class="header"><ul><li><a href="/">GraphQL.NET</a></li><li><a href="/docs/getting-started/introduction/">Docs</a></li><li><a href="https://github.com/graphql-dotnet/graphql-dotnet" rel="noopener noreferrer" target="_blank">GitHub</a></li></ul></nav><div class="page-body"><div class="content"><article class="content-body"><h1 id="field-middleware" style="position:relative;"><a href="#field-middleware" aria-label="field middleware permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Field Middleware</h1>
<p>Field Middleware is a component connected to the schema, which is embedded into the process of
calculating the field value. You can write middleware for fields to provide additional behaviors
during field resolution. After connecting the middleware to the schema, it is applied to all
fields of all schema types. You can connect several middlewares to the schema. In this case,
they will be called sequentially along the chain where the previous middleware decides to call
the next one. This process is very similar to how middlewares work in the ASP.NET Core HTTP request
pipeline.</p>
<p>The following example is how Metrics are captured. You write a class that implements <code class="language-text">IFieldMiddleware</code>:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InstrumentFieldsMiddleware</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFieldMiddleware</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span> <span class="token function">ResolveAsync</span><span class="token punctuation">(</span><span class="token class-name">IResolveFieldContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FieldMiddlewareDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token return-type class-name">context<span class="token punctuation">.</span>Metrics<span class="token punctuation">.</span>Enabled
            <span class="token punctuation">?</span></span> <span class="token function">ResolveWhenMetricsEnabledAsync</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
            <span class="token punctuation">:</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span> <span class="token function">ResolveWhenMetricsEnabledAsync</span><span class="token punctuation">(</span><span class="token class-name">IResolveFieldContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FieldMiddlewareDelegate</span> next<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> context<span class="token punctuation">.</span>FieldAst<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>StringValue<span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> metadata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">{</span> <span class="token string">"typeName"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>ParentType<span class="token punctuation">.</span>Name <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token string">"fieldName"</span><span class="token punctuation">,</span> name <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token string">"returnTypeName"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>FieldDefinition<span class="token punctuation">.</span>ResolvedType<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token string">"path"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Path <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">using</span> <span class="token punctuation">(</span>context<span class="token punctuation">.</span>Metrics<span class="token punctuation">.</span><span class="token function">Subject</span><span class="token punctuation">(</span><span class="token string">"field"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ConfigureAwait</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then register your Field Middleware on the schema.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Schema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span>Query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
schema<span class="token punctuation">.</span>FieldMiddleware<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">InstrumentFieldsMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Or, you can register a middleware delegate directly:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp">schema<span class="token punctuation">.</span>FieldMiddleware<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>next <span class="token operator">=></span>
<span class="token punctuation">{</span>
  <span class="token keyword">return</span> context <span class="token operator">=></span>
  <span class="token punctuation">{</span>
    <span class="token comment">// your code here</span>
    <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// your code here</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>The middleware interface is defined as:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IFieldMiddleware</span>
<span class="token punctuation">{</span>
  <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span> <span class="token function">ResolveAsync</span><span class="token punctuation">(</span><span class="token class-name">IResolveFieldContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FieldMiddlewareDelegate</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div>
<p>The middleware delegate is defined as:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">delegate</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span> <span class="token function">FieldMiddlewareDelegate</span><span class="token punctuation">(</span><span class="token class-name">IResolveFieldContext</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<h2 id="field-middleware-and-dependency-injection" style="position:relative;"><a href="#field-middleware-and-dependency-injection" aria-label="field middleware and dependency injection permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Field Middleware and Dependency Injection</h2>
<p>First, you are advised to read the article about <a href="../dependency-injection">Dependency Injection</a>.</p>
<p>Typically you will want to set the middleware within the schema constructor.</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> MySchema <span class="token punctuation">:</span> Schema
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">MySchema</span><span class="token punctuation">(</span>
    <span class="token class-name">IServiceProvider</span> services<span class="token punctuation">,</span>
    <span class="token class-name">MyQuery</span> query<span class="token punctuation">,</span>
    <span class="token class-name">InstrumentFieldsMiddleware</span> middleware<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Query <span class="token operator">=</span> query<span class="token punctuation">;</span>
    FieldMiddleware<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Then your middleware creation will be delegated to DI-container. Thus, you can pass any dependencies to
the Field Middleware constructor, provided that you have registered them correctly in DI.</p>
<p>Also, the middleware itself should be registered in DI:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>InstrumentFieldsMiddleware<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Alternatively, you can use an enumerable in your constructor to add all DI-registered middlewares:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> MySchema <span class="token punctuation">:</span> Schema
<span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token function">MySchema</span><span class="token punctuation">(</span>
    <span class="token class-name">IServiceProvider</span> services<span class="token punctuation">,</span>
    <span class="token class-name">MyQuery</span> query<span class="token punctuation">,</span>
    <span class="token class-name">IEnumerable<span class="token punctuation">&lt;</span>IFieldMiddleware<span class="token punctuation">></span></span> middlewares<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>services<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    Query <span class="token operator">=</span> query<span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> middleware <span class="token keyword">in</span> middlewares<span class="token punctuation">)</span>
      FieldMiddleware<span class="token punctuation">.</span><span class="token function">Use</span><span class="token punctuation">(</span>middleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// within Startup.cs</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISchema<span class="token punctuation">,</span> MySchema<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFieldMiddleware<span class="token punctuation">,</span> InstrumentFieldsMiddleware<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IFieldMiddleware<span class="token punctuation">,</span> MyMiddleware<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span></code></pre></div>
<h2 id="known-issues" style="position:relative;"><a href="#known-issues" aria-label="known issues permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Known issues</h2>
<p>Perhaps the most important thing with Field Middlewares that you should be aware of is that the
default <code class="language-text">DocumentExecuter</code> applies middlewares to the schema only once while the schema is being
initialized. After this, calling any <code class="language-text">IFieldMiddlewareBuilder.Use</code> methods has no effect.</p>
<p>Field Middleware, when applying to the schema, <strong>modifies</strong> the resolver of each field. Therefore,
you should be careful when using different lifetimes (singleton, scoped, transient) for your
GraphTypes, Schema and Field Middleware. You <strong>can</strong> use any of lifetime, but for example in
case of using singleton lifetime for some GraphType and scoped lifetime for Field Middleware
and Schema this will cause the middleware to be applied to the same fields multiple times.
In the case of ASP.NET Core app the resolvers of these fields will be wrapped again on each
HTTP request to the server.</p>
<p>General recommendations for lifetimes are:</p>
<table>
<thead>
<tr>
<th>Schema</th>
<th>Graph Type</th>
<th>Middleware</th>
<th>Rating</th>
</tr>
</thead>
<tbody>
<tr>
<td>singleton</td>
<td>singleton</td>
<td>singleton</td>
<td>the safest and the most performant option recommended by default</td>
</tr>
<tr>
<td>scoped</td>
<td>scoped</td>
<td>singleton</td>
<td>much less performant option</td>
</tr>
<tr>
<td>scoped</td>
<td>scoped</td>
<td>scoped</td>
<td>the least performant option</td>
</tr>
<tr>
<td>scoped</td>
<td>singleton</td>
<td>scoped</td>
<td>DO NOT DO THAT! Explanation above.</td>
</tr>
<tr>
<td>singleton</td>
<td>singleton</td>
<td>scoped</td>
<td>DO NOT DO THAT! InvalidOperationException: Cannot resolve scoped service from root provider</td>
</tr>
</tbody>
</table>
<p>If your Field Middleware has scoped dependencies but your Schema and Graph Types are singletons
(which is recommended for them) you can make Field Middleware singleton too and obtain the necessary
dependencies right in the <code class="language-text">Resolve</code> method. Here is an example of such an approach:</p>
<div class="gatsby-highlight" data-language="csharp"><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyFieldMiddleware</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IFieldMiddleware</span></span>
<span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHttpContextAccessor</span> _accessor<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMySingletonService</span> _service<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token function">MyFieldMiddleware</span><span class="token punctuation">(</span><span class="token class-name">IHttpContextAccessor</span> accessor<span class="token punctuation">,</span> <span class="token class-name">IMySingletonService</span> service<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    _accessor <span class="token operator">=</span> accessor<span class="token punctuation">;</span>
    _service <span class="token operator">=</span> service<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">></span></span> <span class="token function">ResolveAsync</span><span class="token punctuation">(</span><span class="token class-name">IResolveFieldContext</span> context<span class="token punctuation">,</span> <span class="token class-name">FieldMiddlewareDelegate</span> next<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> scopedDependency1 <span class="token operator">=</span> accessor<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMyService1<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> scopedDependency2 <span class="token operator">=</span> accessor<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IMyService2<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Options are also possible using transient lifetime, but are not given here (not recommended).</p>
<h2 id="field-middleware-vs-directive" style="position:relative;"><a href="#field-middleware-vs-directive" aria-label="field middleware vs directive permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Field Middleware vs Directive</h2>
<p>You can think of a Field Middleware as something global that controls how all fields of all types
in the schema are resolved. A directive, at the same time, would only affect specific schema elements
and only those elements. Moreover, a directive is not limited to field resolvers like middleware is.
For more information about directives see <a href="https://graphql-dotnet.github.io/docs/getting-started/directives">Directives</a>.</p></article><div class="content-toolbar"><a href="https://github.com/graphql-dotnet/graphql-dotnet/edit/master/docs2/site/docs/getting-started/field-middleware.md" rel="noopener noreferrer" target="_blank">Edit this page on GitHub</a></div></div><div class="nav"><nav><ul><li><span>Getting Started</span><nav><ul><li><a class="" href="/docs/getting-started/introduction/">Introduction</a></li><li><a class="" href="/docs/getting-started/installation/">Installation</a></li><li><a class="" href="/docs/getting-started/graphiql/">GraphiQL</a></li><li><a class="" href="/docs/getting-started/altair-graphql/">Altair GraphQL</a></li><li><a class="" href="/docs/getting-started/queries/">Queries</a></li><li><a class="" href="/docs/getting-started/schema-types/">Schema Types</a></li><li><a class="" href="/docs/getting-started/custom-scalars/">Custom Scalars</a></li><li><a class="" href="/docs/getting-started/lists-non-null/">Lists and Non-Null</a></li><li><a class="" href="/docs/getting-started/arguments/">Arguments</a></li><li><a class="" href="/docs/getting-started/aliases/">Aliases</a></li><li><a class="" href="/docs/getting-started/fragments/">Fragments</a></li><li><a class="" href="/docs/getting-started/variables/">Variables</a></li><li><a class="" href="/docs/getting-started/directives/">Directives</a></li><li><a class="" href="/docs/getting-started/mutations/">Mutations</a></li><li><a class="" href="/docs/getting-started/interfaces/">Interfaces</a></li><li><a class="" href="/docs/getting-started/unions/">Unions</a></li><li><a class="" href="/docs/getting-started/subscriptions/">Subscriptions</a></li><li><a class="" href="/docs/getting-started/query-validation/">Query Validation</a></li><li><a class="" href="/docs/getting-started/query-organization/">Query Organization</a></li><li><a class="" href="/docs/getting-started/user-context/">User Context</a></li><li><a class="" href="/docs/getting-started/errors/">Error Handling</a></li><li><a class="" href="/docs/getting-started/dependency-injection/">Dependency Injection</a></li><li><a class="" href="/docs/getting-started/databases/">Databases</a></li><li><a class="" href="/docs/getting-started/malicious-queries/">Malicious Queries</a></li><li><a class="" href="/docs/getting-started/metadata/">Object/Field Metadata</a></li><li><a aria-current="page" class="active" href="/docs/getting-started/field-middleware/">Field Middleware</a></li><li><a class="" href="/docs/getting-started/metrics/">Metrics</a></li><li><a class="" href="/docs/getting-started/authorization/">Authorization</a></li><li><a class="" href="/docs/getting-started/relay/">Relay</a></li><li><a class="" href="/docs/getting-started/global-switches/">Global Switches</a></li></ul></nav></li><li><span>Guides</span><nav><ul><li><a class="" href="/docs/guides/serialization/">Serialization</a></li><li><a class="" href="/docs/guides/dataloader/">Dataloader</a></li><li><a class="" href="/docs/guides/schema-generation/">Schema Generation</a></li><li><a class="" href="/docs/guides/known-issues/">Known Issues &amp; FAQ</a></li><li><a class="" href="/docs/guides/links/">Links</a></li><li><a class="" href="/docs/guides/document-caching/">Document Caching</a></li></ul></nav></li><li><span>Migration Guides</span><nav><ul><li><a class="" href="/docs/migrations/migration7/">Migration Guide [v5 -&gt; v7]</a></li><li><a class="" href="/docs/migrations/migration5/">Migration Guide [v4 -&gt; v5]</a></li><li><a class="" href="/docs/migrations/migration4/">Migration Guide [v3 -&gt; v4]</a></li><li><a class="" href="/docs/migrations/migration3/">Migration Guide [v2 -&gt; v3]</a></li><li><a class="" href="/docs/migrations/migration2/">Migration Guide [v0.17.x -&gt; v2]</a></li><li><a class="" href="/docs/migrations/v0_11_0/">Migration Guide [v0.11.0]</a></li><li><a class="" href="/docs/migrations/v0_8_0/">Migration Guide [v0.8.0]</a></li></ul></nav></li></ul></nav></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/docs/getting-started/field-middleware/";/*]]>*/</script><!-- slice-start id="_gatsby-scripts-1" -->
          <script
            id="gatsby-chunk-mapping"
          >
            window.___chunkMapping="{\"app\":[\"/app-436da0dacbc7d0c9c70c.js\"],\"component---site-pages-landing-js\":[\"/component---site-pages-landing-js-a6440981f4cabd99c44a.js\"],\"component---src-components-docs-page-js\":[\"/component---src-components-docs-page-js-eb3cf7402e33f3b8c598.js\"],\"component---src-pages-404-js\":[\"/component---src-pages-404-js-124a3edb7b6bf3b7b21f.js\"]}";
          </script>
        <script>window.___webpackCompilationHash="aa7a2afce7502c334a0a";</script><script src="/webpack-runtime-bc7601c4417363e3cebe.js" async></script><script src="/framework-5fba739d9f48dd9733f3.js" async></script><script src="/app-436da0dacbc7d0c9c70c.js" async></script><!-- slice-end id="_gatsby-scripts-1" --></body></html>