{"componentChunkName":"component---src-components-docs-page-js","path":"/docs/getting-started/dependency-injection/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"dependency-injection\" style=\"position:relative;\"><a href=\"#dependency-injection\" aria-label=\"dependency injection permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency Injection</h1>\n<p>GraphQL.NET supports dependency injection through a <code class=\"language-text\">IServiceProvider</code> interface that is passed to the Schema class. Internally when trying to resolve a type the library will call the methods on this interface.</p>\n<blockquote>\n<p>The library resolves a <code class=\"language-text\">GraphType</code> only once and caches that type for the lifetime of the <code class=\"language-text\">Schema</code>.</p>\n</blockquote>\n<p>The default implementation of <code class=\"language-text\">IServiceProvider</code> uses <code class=\"language-text\">Activator.CreateInstance</code>. <code class=\"language-text\">Activator.CreateInstance</code> requires that an object have a public parameterless constructor.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DefaultServiceProvider</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IServiceProvider</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">object</span></span> <span class=\"token function\">GetService</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Type</span> serviceType<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>serviceType <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ArgumentNullException</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>serviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">try</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> Activator<span class=\"token punctuation\">.</span><span class=\"token function\">CreateInstance</span><span class=\"token punctuation\">(</span>serviceType<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Exception</span> exception<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Exception</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Failed to call Activator.CreateInstance. Type: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">serviceType<span class=\"token punctuation\">.</span>FullName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">,</span> exception<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You can override the default implementation by passing a <code class=\"language-text\">IServiceProvider</code> to the constructor of your <code class=\"language-text\">Schema</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StarWarsSchema</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">GraphQL<span class=\"token punctuation\">.</span>Types<span class=\"token punctuation\">.</span>Schema</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">StarWarsSchema</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceProvider</span> provider<span class=\"token punctuation\">,</span> <span class=\"token class-name\">StarWarsQuery</span> query<span class=\"token punctuation\">,</span> <span class=\"token class-name\">StarWarsMutation</span> mutation<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">:</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">(</span>provider<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Query <span class=\"token operator\">=</span> query<span class=\"token punctuation\">;</span>\n        Mutation <span class=\"token operator\">=</span> mutation<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>How you integrate this into your system will depend on the dependency injection framework you are using. <code class=\"language-text\">FuncServiceProvider</code> is provided for easy integration with multiple containers.</p>\n<h2 id=\"dependency-injection-registration-helpers\" style=\"position:relative;\"><a href=\"#dependency-injection-registration-helpers\" aria-label=\"dependency injection registration helpers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dependency Injection Registration Helpers</h2>\n<p>GraphQL.NET provides an <code class=\"language-text\">IGraphQLBuilder</code> interface which encapsulates the configuration methods of a dependency injection framework, to provide an\nabstract method of configuring a dependency injection framework to work with GraphQL.NET. This interface is provided through a configuration delegate\nfrom a DI-provider-specific setup method (typically called <code class=\"language-text\">AddGraphQL()</code>), at which point you can call extension methods on the interface to\nconfigure this library. A simple example is below:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\">services<span class=\"token punctuation\">.</span><span class=\"token function\">AddGraphQL</span><span class=\"token punctuation\">(</span>builder <span class=\"token operator\">=></span> builder\n    <span class=\"token punctuation\">.</span><span class=\"token function\">AddSystemTextJson</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSchema</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MySchema<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>The interface also allows configuration of the schema during initialization, and configuration of the execution at runtime. In this manner, adding\nmiddleware, for example, is as simple as calling <code class=\"language-text\">.AddMiddleware&lt;MyMiddlware>()</code> and does not require the middleware to be added into the schema\nconfiguration.</p>\n<p>The <code class=\"language-text\">AddGraphQL()</code> method will register default implementations of the following services within the dependency injection framework:</p>\n<ul>\n<li><code class=\"language-text\">IDocumentExecuter</code></li>\n<li><code class=\"language-text\">IDocumentBuilder</code></li>\n<li><code class=\"language-text\">IDocumentValidator</code></li>\n<li><code class=\"language-text\">IErrorInfoProvider</code></li>\n<li><code class=\"language-text\">IExecutionStrategySelector</code> - which does not support subscriptions by default</li>\n</ul>\n<p>A list of the available extension methods is below:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Description / Notes</th>\n<th>Library</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">AddAutoClrMappings</code></td>\n<td>Configures unmapped CLR types to use auto-registering graph types</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddAutoSchema</code></td>\n<td>Registers a schema based on CLR types</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddClrTypeMappings</code></td>\n<td>Scans the specified assembly for graph types intended to represent CLR types and registers them within the schema</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddComplexityAnalyzer</code></td>\n<td>Enables the complexity analyzer and configures its options</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddDataLoader</code></td>\n<td>Registers classes necessary for data loader support</td>\n<td>GraphQL.DataLoader</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddDocumentCache&lt;></code></td>\n<td>Registers the specified document caching service</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddDocumentExecuter&lt;></code></td>\n<td>Registers the specified document executer; useful when needed to change the execution strategy utilized</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddDocumentListener&lt;></code></td>\n<td>Registers the specified document listener and configures execution to use it</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddErrorInfoProvider</code></td>\n<td>Registers a custom error info provider or configures the default error info provider</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddExecutionStrategy</code></td>\n<td>Registers an <code class=\"language-text\">ExecutionStrategyRegistration</code> for the selected execution strategy and operation type</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddExecutionStrategySelector</code></td>\n<td>Registers the specified execution strategy selector</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddFederation</code></td>\n<td>Registers the federation types and configures the schema to support Apollo Federation</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddGraphTypes</code></td>\n<td>Scans the specified assembly for graph types and registers them within the DI framework</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddGraphTypeMappingProvider</code></td>\n<td>Registers a graph type mapping provider for unmapped CLR types</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddLegacyComplexityAnalyzer</code></td>\n<td>Enables the v7 complexity analyzer and configures its options</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddNewtonsoftJson</code></td>\n<td>Registers the serializer that uses Newtonsoft.Json as its underlying JSON serialization engine</td>\n<td>GraphQL.NewtonsoftJson</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddSchema&lt;></code></td>\n<td>Registers the specified schema</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddSchemaVisitor&lt;></code></td>\n<td>Registers the specified schema visitor and configures it to be used at schema initialization</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddSelfActivatingSchema&lt;></code></td>\n<td>Registers the specified schema which will create instances of unregistered graph types during initialization</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddSerializer&lt;></code></td>\n<td>Registers the specified serializer</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddSystemTextJson</code></td>\n<td>Registers the serializer that uses System.Text.Json as its underlying JSON serialization engine</td>\n<td>GraphQL.SystemTextJson</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddUnhandledExceptionHandler</code></td>\n<td>Configures the unhandled exception handler</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">AddValidationRule&lt;></code></td>\n<td>Registers the specified validation rule and configures it to be used at runtime</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">ConfigureExecution</code></td>\n<td>Configures execution middleware to monitor or modify both options and the result</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">ConfigureExecutionOptions</code></td>\n<td>Configures execution options at runtime</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">ConfigureSchema</code></td>\n<td>Configures schema options when the schema is initialized</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">Configure&lt;TOptions></code></td>\n<td>Used by extension methods to configures an options class within the DI framework</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UseApolloTracing</code></td>\n<td>Registers and enables metrics depending on the supplied arguments, and adds Apollo Tracing data to the execution result</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UseAutomaticPersistedQueries</code></td>\n<td>Enables Automatic Persisted Queries support</td>\n<td>GraphQL.MemoryCache</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UseMemoryCache</code></td>\n<td>Registers the memory document cache and configures its options</td>\n<td>GraphQL.MemoryCache</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UseMiddleware&lt;></code></td>\n<td>Registers the specified middleware and configures it to be installed during schema initialization</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UsePersistedDocuments</code></td>\n<td>Registers the persisted document handler and configures its options</td>\n<td></td>\n</tr>\n<tr>\n<td><code class=\"language-text\">UseTelemetry</code></td>\n<td>Creates telemetry events based on the System.Diagnostics.Activity API, primarily for use with OpenTelemetry</td>\n<td>.NET 5+</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">WithTimeout</code></td>\n<td>Configures the execution timeout</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>The above methods will register the specified services typically as singletons unless otherwise specified. Graph types and middleware are registered\nas transients so that they will match the schema lifetime. So with a singleton schema, all services are effectively singletons.</p>\n<p>Calls to <code class=\"language-text\">ConfigureExecutionOptions</code> and methods that start with <code class=\"language-text\">Add</code> will execute first, in the order they\nappear, followed by calls to <code class=\"language-text\">ConfigureExecution</code> and methods that start with <code class=\"language-text\">Use</code>. The order of the calls\nmay be important. For instance, calling <code class=\"language-text\">UseMemoryCache</code> prior to <code class=\"language-text\">UseAutomaticPersistedQueries</code> would result in\nthe memory cache being unable to cache any APQ queries.</p>\n<p>Custom <code class=\"language-text\">IGraphQLBuilder</code> extension methods typically rely on the <code class=\"language-text\">Services</code> property of the builder in order to register services\nwith the underlying dependency injection framework. The <code class=\"language-text\">Services</code> property returns a <code class=\"language-text\">IServiceRegister</code> interface which has these methods:</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code class=\"language-text\">Register</code></td>\n<td>Registers a service within the DI framework replacing existing registration if needed</td>\n</tr>\n<tr>\n<td><code class=\"language-text\">TryRegister</code></td>\n<td>Registers a service within the DI framework if it has not already been registered</td>\n</tr>\n</tbody>\n</table>\n<p>To use the <code class=\"language-text\">AddGraphQL</code> method, you will need to install the proper nuget package for your DI provider. See list below:</p>\n<table>\n<thead>\n<tr>\n<th>DI Provider</th>\n<th>Nuget Package</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Microsoft.Extensions.DependencyInjection</td>\n<td>GraphQL.MicrosoftDI</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"aspnet-core\" style=\"position:relative;\"><a href=\"#aspnet-core\" aria-label=\"aspnet core permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ASP.NET Core</h2>\n<p><a href=\"https://github.com/graphql-dotnet/examples/blob/8d5b7544006902f45b818010585b1ffa86ef446b/src/AspNetCoreCustom/Example/Startup.cs#L16-L34\">See this example.</a></p>\n<p><code class=\"language-text\">Microsoft.Extensions.DependencyInjection</code> package used in ASP.NET Core already has support for resolving <code class=\"language-text\">IServiceProvider</code> interface so no additional settings are required - just add your required dependencies:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IDocumentExecuter<span class=\"token punctuation\">,</span> DocumentExecuter<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IGraphQLSerializer<span class=\"token punctuation\">,</span> GraphQLSerializer<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StarWarsData<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StarWarsQuery<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StarWarsMutation<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>HumanType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>HumanInputType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DroidType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CharacterInterface<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>EpisodeEnum<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ISchema<span class=\"token punctuation\">,</span> StarWarsSchema<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>To avoid having to register all of the individual graph types in your project, you can\nimport the <a href=\"https://www.nuget.org/packages/GraphQL.MicrosoftDI\">GraphQL.MicrosoftDI NuGet package</a>\npackage and utilize the <code class=\"language-text\">SelfActivatingServiceProvider</code> wrapper as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddSingleton</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ISchema<span class=\"token punctuation\">,</span> StarWarsSchema<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>services <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StarWarsSchema</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SelfActivatingServiceProvider</span><span class=\"token punctuation\">(</span>services<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you previously pulled in your query, mutation and/or subscription classes via dependency injection, you will need\nto manually pull in those dependencies from the <code class=\"language-text\">SelfActivatingServiceProvider</code> via <code class=\"language-text\">GetRequiredService</code> as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StarWarsSchema</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Schema</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">StarWarsSchema</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceProvider</span> serviceProvider<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">:</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">(</span>serviceProvider<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Query <span class=\"token operator\">=</span> serviceProvider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StarWarsQuery<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Mutation <span class=\"token operator\">=</span> serviceProvider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>StarWarsMutation<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>No other graph types will need to be registered. Graph types will only be instantiated once, during schema initialization\nas usual. Graph types can also pull in any services registered with dependency injection as usual.</p>\n<p>Note that if any of the graph types directly or indirectly implement <code class=\"language-text\">IDisposable</code>, be sure to register those types with your dependency\ninjection provider, or their <code class=\"language-text\">Dispose</code> methods will not be called. Any dependencies of graph types that implement\n<code class=\"language-text\">IDisposable</code> will be disposed of properly, regardless of whether the graph type is registered within the service provider.</p>\n<p>You can also use the <code class=\"language-text\">.AddGraphTypes()</code> builder method to scan the calling or specified assembly for classes that implement\n<code class=\"language-text\">IGraphType</code> and register them all as transients within the service provider. Mark your class with <code class=\"language-text\">DoNotRegisterAttribute</code> if you\nwant to skip registration.</p>\n<h2 id=\"nancy-tinyioccontainer\" style=\"position:relative;\"><a href=\"#nancy-tinyioccontainer\" aria-label=\"nancy tinyioccontainer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Nancy TinyIoCContainer</h2>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureApplicationContainer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TinyIoCContainer</span> container<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureApplicationContainer</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    container<span class=\"token punctuation\">.</span><span class=\"token function\">Register</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">,</span> overloads<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StarWarsSchema</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FuncServiceProvider</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span>Resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"simplecontainer\" style=\"position:relative;\"><a href=\"#simplecontainer\" aria-label=\"simplecontainer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SimpleContainer</h2>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> container <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SimpleContainer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ncontainer<span class=\"token punctuation\">.</span><span class=\"token function\">Singleton</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">StarWarsSchema</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FuncServiceProvider</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">.</span>Get<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"autofac\" style=\"position:relative;\"><a href=\"#autofac\" aria-label=\"autofac permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Autofac</h2>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Load</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ContainerBuilder</span> builder<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    builder\n      <span class=\"token punctuation\">.</span><span class=\"token function\">Register</span><span class=\"token punctuation\">(</span>c <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">FuncServiceProvider</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Resolve</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IComponentContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Resolve<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">As</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IServiceProvider<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">InstancePerDependency</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"castle-windsor\" style=\"position:relative;\"><a href=\"#castle-windsor\" aria-label=\"castle windsor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Castle Windsor</h2>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Install</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IWindsorContainer</span> container<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IConfigurationStore</span> store<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    container<span class=\"token punctuation\">.</span><span class=\"token function\">Register</span><span class=\"token punctuation\">(</span>\n      Component\n        <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">For</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IServiceProvider<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">UsingFactoryMethod</span><span class=\"token punctuation\">(</span>k <span class=\"token operator\">=></span> k<span class=\"token punctuation\">.</span>Resolve<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"schema-service-lifetime\" style=\"position:relative;\"><a href=\"#schema-service-lifetime\" aria-label=\"schema service lifetime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Schema Service Lifetime</h1>\n<p>Most dependency injection frameworks allow for specifying different service lifetimes for different\nservices. Although they may have different names with different frameworks, the three most common\nlifetimes are as follows:</p>\n<ul>\n<li><strong>Transient</strong> services are created every time they are injected or requested.</li>\n<li><strong>Scoped</strong> services are created per scope. In a web application, every web request creates a new unique service scope. That means scoped services are generally created per web request.</li>\n<li><strong>Singleton</strong> services are created per DI container. That generally means that they are created only one time per application and then used for whole the application life time.</li>\n</ul>\n<blockquote>\n<p>It is <em>highly</em> recommended that the schema is registered as a singleton. As all graph types are constructed at the</p>\n</blockquote>\n<p>same time as the schema, all graph types will effectively have a singleton lifetime, regardless\nof how it is registered with the DI framework. This is most performant approach. Having a scoped schema can degrade performance\nby a huge margin. For instance, even a small schema execution can slow down by 100x, and much more with a large schema.</p>\n<p>Scoped lifetime can be used to allow the schema and all its graph types access to the current DI scope.\nThis is not recommended; please see <a href=\"#scoped-services-with-a-singleton-schema-lifetime\">Scoped Services</a>\nbelow. With scoped schemas, it is <strong>required</strong> that all its graph types are registered within the DI\nframework as scoped or transient services.</p>\n<p>Transient lifetime is also not recommended due to performance degradation. For schemas having a transient\nlifetime, it is <strong>required</strong> that all its graph types are also registered within the DI framework as\ntransient services.</p>\n<h1 id=\"scoped-services-with-a-singleton-schema-lifetime\" style=\"position:relative;\"><a href=\"#scoped-services-with-a-singleton-schema-lifetime\" aria-label=\"scoped services with a singleton schema lifetime permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scoped services with a singleton schema lifetime</h1>\n<p>For reasons described above, it is recommended that the schema is registered as a singleton within\nthe dependency injection framework. However, this prevents including scoped services within the\nconstructor of the schema or your custom graph types.</p>\n<p>To use scoped services (e.g. HttpContext scoped services in ASP.NET Core) you will need to pass\nthe scoped service provider into the <code class=\"language-text\">ExecutionOptions.RequestServices</code> property. Then within\nany field resolver or field middleware, you can access the <code class=\"language-text\">IResolveFieldContext.RequestServices</code>\nproperty to resolve types via the scoped service provider. Typical integration with ASP.NET Core\nmight look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">var</span></span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> _executer<span class=\"token punctuation\">.</span><span class=\"token function\">ExecuteAsync</span><span class=\"token punctuation\">(</span>options <span class=\"token operator\">=></span>\n<span class=\"token punctuation\">{</span>\n    options<span class=\"token punctuation\">.</span>Schema <span class=\"token operator\">=</span> _schema<span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>Query <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>Query<span class=\"token punctuation\">;</span>\n    options<span class=\"token punctuation\">.</span>Variables <span class=\"token operator\">=</span> _serializer<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Deserialize</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Inputs<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>Variables<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// IGraphQLTextSerializer from DI</span>\n    options<span class=\"token punctuation\">.</span>RequestServices <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>RequestServices<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>You could then call scoped services from within field resolvers as shown in the following example:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StarWarsQuery</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ObjectGraphType</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">StarWarsQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token generic-method\"><span class=\"token function\">Field</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DroidType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hero\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> context<span class=\"token punctuation\">.</span>RequestServices<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IDroidRepo<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">GetDroid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"R2-D2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"thread-safety-with-scoped-services\" style=\"position:relative;\"><a href=\"#thread-safety-with-scoped-services\" aria-label=\"thread safety with scoped services permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread safety with scoped services</h1>\n<p>When using scoped services, be aware that most scoped services are not thread-safe. Therefore you will likely\nneed to use the <code class=\"language-text\">SerialExecutionStrategy</code> execution strategy, or write code to create a service scope\nfor the duration of the execution of the field resolver that requires a scoped service. For instance, with\nEntity Framework Core, typically the database context is registered as a scoped service and obtained via\ndependency injection. To continue to use the database context in the same manner with a singleton schema,\nyou would need to use a serial execution strategy, or create a scope within each field resolver that\nrequires database access, as shown in the following example:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StarWarsQuery</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ObjectGraphType</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">StarWarsQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token generic-method\"><span class=\"token function\">Field</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DroidType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hero\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> scope <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>RequestServices<span class=\"token punctuation\">.</span><span class=\"token function\">CreateScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> services <span class=\"token operator\">=</span> scope<span class=\"token punctuation\">.</span>ServiceProvider<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MyDbContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Droids<span class=\"token punctuation\">.</span><span class=\"token function\">Find</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>There are classes to assist with this within the <a href=\"https://www.nuget.org/packages/GraphQL.MicrosoftDI\">GraphQL.MicrosoftDI NuGet package</a>.\nSample usage is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyGraphType</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ObjectGraphType<span class=\"token punctuation\">&lt;</span>Category<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">MyGraphType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> context<span class=\"token punctuation\">.</span>Source<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token generic-method\"><span class=\"token function\">Field</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ListGraphType<span class=\"token punctuation\">&lt;</span>ProductGraphType<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Products\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">ResolveScopedAsync</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> db <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>RequestServices<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MyDbContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> db<span class=\"token punctuation\">.</span>Products<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>CategoryId <span class=\"token operator\">==</span> context<span class=\"token punctuation\">.</span>Source<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToListAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In this case <code class=\"language-text\">context.RequestServices</code> will be an <code class=\"language-text\">IServiceProvider</code> in a newly created scope.</p>\n<p>Be aware that using the service locator in this fashion described in this section could be considered an\nAnti-Pattern. See <a href=\"https://blog.ploeh.dk/2010/02/03/ServiceLocatorisanAnti-Pattern/\">Service Locator is an Anti-Pattern</a>.\nHowever, the performance benefits far outweigh the anti-pattern idealogy, when compared to creating a scoped schema.</p>\n<p>Within the <code class=\"language-text\">GraphQL.MicrosoftDI</code> package, there is also a builder approach to adding scoped dependencies.\nThis makes for a concise and declarative approach. Each field clearly states the services it needs\nand thereby, the anti-pattern argument does not apply anymore.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyGraphType</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ObjectGraphType<span class=\"token punctuation\">&lt;</span>Category<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">MyGraphType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">Field</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> context<span class=\"token punctuation\">.</span>Source<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token generic-method\"><span class=\"token function\">Field</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>ListGraphType<span class=\"token punctuation\">&lt;</span>ProductGraphType<span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Products\"</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">WithScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// creates a service scope as described above; not necessary for serial execution</span>\n            <span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">WithService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>MyDbContext<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">ResolveAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> db<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> db<span class=\"token punctuation\">.</span>Products<span class=\"token punctuation\">.</span><span class=\"token function\">Where</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>CategoryId <span class=\"token operator\">==</span> context<span class=\"token punctuation\">.</span>Source<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToListAsync</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Another approach to resolve scoped services is to use the SteroidsDI project, as described below.</p>\n<h2 id=\"using-steroidsdi\" style=\"position:relative;\"><a href=\"#using-steroidsdi\" aria-label=\"using steroidsdi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Using SteroidsDI</h2>\n<p>To use <a href=\"https://github.com/sungam3r/SteroidsDI\">SteroidsDI</a> with ASP.NET Core, add <code class=\"language-text\">Defer&lt;></code> and <code class=\"language-text\">IScopeProvider</code> in your <code class=\"language-text\">Startup.ConfigureServices</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token comment\">// Add SteroidsDI Open Generic Defer&lt;> Factory Class</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddDefer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">// Add SteroidsDI IScopeProvider to use the AspNetCoreHttpScopeProvider</span>\n    <span class=\"token comment\">// which internally uses the IHttpContextAccessor.HttpContext.RequestServices;</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddHttpScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then in your query graph types you can request services using <code class=\"language-text\">Defer&lt;T></code> to be injected via DI,\nwhich will be evaluated at runtime to their relevant Scoped services, <code class=\"language-text\">T</code> has been registered with a <code class=\"language-text\">Scoped</code> DI lifetime:</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">StarWarsQuery</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ObjectGraphType</span></span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// #1 - Add dependencies using Defer&lt;T></span>\n  <span class=\"token keyword\">public</span> <span class=\"token function\">StarWarsQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Defer<span class=\"token punctuation\">&lt;</span>IDroidRepo<span class=\"token punctuation\">></span></span> repoFactory<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token generic-method\"><span class=\"token function\">Field</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>DroidType<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hero\"</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// #2 Resolve dependencies using current scope provider</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">Resolve</span><span class=\"token punctuation\">(</span>context <span class=\"token operator\">=></span> repoFactory<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">.</span><span class=\"token function\">GetDroid</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"R2-D2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ol>\n<li>Add <code class=\"language-text\">Defer&lt;T></code> to be injected by the dependency injection container. This is a factory which upon calling <code class=\"language-text\">Defer.Value</code> will resolve the requested service using any currently registered scope provider (e.g. <code class=\"language-text\">AspNetCoreHttpScopeProvider</code>)</li>\n<li>Use the <code class=\"language-text\">Defer&lt;T></code> factory class to resolve the requested dependency using any currently registered scope provider. In our case it will attempt to use the <code class=\"language-text\">IHttpContextAccessor.HttpContext.RequestServices</code> which is the ASP.NET Core Scoped <code class=\"language-text\">IServiceProvider</code> in order to resolve the dependency.</li>\n</ol>","fields":{"relativePath":"docs/getting-started/dependency-injection.md"}},"site":{"siteMetadata":{"githubEditUrl":"https://github.com/graphql-dotnet/graphql-dotnet/edit/master/docs2/site"}}},"pageContext":{"relativePath":"docs/getting-started/dependency-injection.md"}},"staticQueryHashes":["3402777086"],"slicesMap":{}}